---
title: "HDAT9700: Assessment 3 - Chapters 7-8"
subtitle: "Time series analysis"
author: "Mark Hanly"
date: "December 2024"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Load data
df <- read.csv('flhom.csv')

# Convert to time series object
flhom <- ts(df[,2], start=c(2000,1), frequency=12)

# Load libraries
library(forecast)
library(astsa)
library(ggplot2)
library(dplyr)

```

## Section 1

### Q1. Describe the pre-intervention time series of total firearm deaths per 100,000 people (Figure 1a) in terms of trend and seasonality.

![Figure 1A from Ukert (2018)](ukert-2018-fig1a.png)

Figure 1a from Ukert (2018) shows an overall downward trend in total firearm mortality per 100,000 people in Australia between 1978 and 1996. In 1978, there were around 4.3 firearm deaths per 100,000 people, declining to around 2.7 deaths per 100,000 in 1996. The gradual downward trend is reasonably consistent throughout this period, except for the mid-to-late 80s where the rates were constant between around 4.1 and 4.3 deaths per 100,000 people. 

Because these are annual data, seasonality cannot be detected here.


### Q2. In your own words, summarise what it means and what the purpose of (i) taking the first difference and (ii) including an autoregressive order 1. 

The first difference of a time series is the difference between consecutive observations. This is done to remove the trend from the data, which is one step in achieving a stationary series.

An autoregressive model of order 1 (AR(1)) is a model that predicts the value of a time series at time $t$ based on the value of the series at time $t-1$. This is done to account for the autocorrelation in the data, which is the correlation between observations at different time points. In this case, the AR(1) model is used to account for the fact that the value of the time series at time $t$ is likely to be related to the value of the series at time $t-1$. 

### Q3. Explain in your own words (i) what is the role of the robustness check, (ii) how is it implemented, and (iii) what is the interpretation. 

The role of the robustness check here is to test whether changes in firearm mortality rate can be  attributed to the introduction of the 1996 firearm law. This is done by running a series of models with fictitious intervention dates for years preceding the policy change, from 1990 to 1995. The robustness check shows that for the ARIMA model, the only model that shows a significant effect is the one where the true intervention date is modelled, with the results from the models with fictitious intervention dates being non-significant. This suggests that the results from the ARIMA model are robust to changes in the intervention date. In contrast, the same robustness check applied to the negative binomial model finds "significant" impacts even for the fictitious intervention dates, suggesting that the negative binomial model is not satisfactorily capturing the trend and autocorrelation in the time series. 



## Section 2

### Q1. Create a plot of the homicide rate over time

```{r}

plotDf <- df |> 
  mutate(
    dt = as.Date(paste0("01-", date),
                 format="%d-%B-%y")
  )

ggplot(data = plotDf,
       aes(x=dt, y=hom_rate)) +
  geom_vline(xintercept = as.Date("2005-10-01"),
             linewidth=1, color='hotpink') +
  geom_label(aes(y=0.35, 
                 x=as.Date("2005-10-01"), 
                 label = "October 2005\nSYG policy introduced"),
             fill = 'hotpink',
             color = 'white',
             size=8/.pt,
             hjust=0,
             nudge_x = 0
             ) +
  geom_line(group=1) +
  geom_point(shape=21, fill = 'grey80') +
  scale_x_date("Date") +
  scale_y_continuous("Homicide rate per 100,000 population") +
  labs(
    title = "Monthly homicide rate per 100,000 population in Florida, 2000-2007"
  ) +
  theme(
    plot.title = element_text(size = 12),
  ) + theme_minimal()
```


### Q2. Describe the homicide rate time series in terms of the trend, seasonality, and outliers

Overall, the median homicide rate per 100,000 population per month was 0.50 (interquartile range, 0.46 to 0.56).

* *Trend*: The homicide rate was relatively constant prior to the intervention. After the intervention in October 2005, it started to increase until the end of the study period in December 2007. Looking at the seasonal plot, the homicide rate is mostly highest in 2007, at the end of the series post-intervention. This suggests that the change in the homicide rate post-intervention might best be described by a change in slope.

* *Seasonality*: The homicide rate appears lowest in February of each year, but no other clear patterns are observed during the rest of the year. The median value in February was 0.44 per 100,000, while it was highest in July (median=0.56). Given this, we will consider including seasonality in our regression models.

* *Outliers*: Looking at the seasonal plot, February 2005 (0.31 homicides per 100,000) is lower than all other values. In contrast, the homicide rate in July 2008 is highest (0.78 homicides per 100,000). However, in the "random" panel of the decomposition plot these values don't appear quite as extreme suggesting it may be partly due to seasonal effects. Given this, and the lack of any prior evidence that there was anything different about these months, we will leave them as is.
  
```{r q2_1, echo=FALSE, fig.height=3.5, fig.width=4}
# Decomposition plots

par(mfrow=c(2,2), cex.main=.8, cex.lab=.8)
plot(decompose(flhom))

# Seasonal plots
ggseasonplot(flhom)
```

```{r q2_2, include=FALSE}
#Summary stats
summary(flhom)

#Summary stats by month
tapply(flhom, cycle(flhom), summary)
```
### Q3. Estimate the effect of the stand-your-ground law using segmented regression and ARIMA. 

#### Segmented regression

Starting with segmented regression, I will fit two models: 

* **Model 1** - hom_rate ~ time + syg + time.after + month
* **Model 2** - hom_rate ~ time + syg.lag1 + time.after.lag1 + month

Here, `time` is the time since start of the study, `syg` is an indicator for the "Stand-your-ground" law (before=0, after=1), `time.after` is the time since the law was implemented and `month` is a monthly dummy variable. The second model tests for a delayed effect of the policy change: `syg.lag1` and `time.after.lag1` are `syg` and `time.after` delayed/lagged by one month.

The two models are presented below. 

```{r}
#Time variable representing baseline slope
time <- ts(seq(1,length(flhom)), start=c(2000,1), frequency=12)

#Step change variable representing level shift post intervention
syg <- ts(ifelse(time(flhom)<2005.75,0,1),
          start=c(2000,1), frequency=12)

syg.lag1 <- ts(ifelse(time(flhom)<2005.833,0,1),
          start=c(2000,1), frequency=12)

#Time since intervention representing change in slope
time.after <- ts(append(rep(0,sum(time(flhom)<2005.75)),seq(1,sum(syg))), start=c(2000,1), frequency=12)

time.after.lag1 <- ts(append(rep(0, sum(time(flhom)<2005.833)), seq(1,sum(syg.lag1))), start=c(2000,1), frequency=12)

#Monthly dummy variables
month <- seasonaldummy(flhom)

model1 <- lm(flhom ~ time + syg + time.after + month)
model2 <- lm(flhom ~ time + syg.lag1 + time.after.lag1 + month)

sjPlot::tab_model(model1, model2, digits = 4, show.r2 = FALSE ,show.aic = TRUE)

```

The model fits are very similar, although the AIC is slightly lower for Model 2. This suggests that the delayed effect of the policy change is better captured by the second model.

#### ARIMA modelling

To begin, I will run `forecast::auto.arima()` fixing `d=1` to account for the trend in the data. This suggests a model of the form ARIMA(0,1,1)(0,0,2)[12]. I will then refit this model using `astsa::sarima()` to include the variables `syg.lag1` and `time.after.lag1` which capture the lagged step change and slope change post-intervention. 

```{r}
auto.arima(flhom, d=1) # Suggests ARIMA(0,1,1)(0,0,2)[12] 

# Refit with astsa::sarima()
arima1 <- sarima(flhom, xreg = cbind(syg.lag1, time.after.lag1), p=0, d=1, q=1, P=0, D=0, Q=2, S=12) # SARIMA(0,1,1)(0,0,2)[12])
```

The residual plots indicate that the ARIMA model has adequately captured the trend and seasonality in the data. The residuals are approximately normally distributed, and there are no obvious patterns in the ACF plot. 

### Q4. Using the "best" model from question (3), summarise your findings and write a conclusion describing the impact of the law on the homicide rate in Florida

Given it's simplicity, I will use the segmented regression model with the delayed effect of the policy change to estimate the impact of the Stand-your-ground law. 

Prior to the intervention in October 2005, the monthly homicide rate per 100,000 population in Florida was constant over time with a slope of -0.0004 per month (95% CI -0.001 to 0.0003). In November 2005, one month after the introduction of the Stand-your-ground law, the monthly homicide rate per 100,000 population increased by a level shift of 0.056 (95% CI 0.005 to 0.107), and there was a change in slope of 0.004 (95% CI 0.0008 to 0.007). This means that after the law was introduced, the homicide rate was increasing by 0.004 per 100,000 population per month up until the end of the study period in December 2007. Thus, the introduction of the Stand-your-ground law was associated with an increase in the homicide rate in Florida.

### Q5. Give two examples of possible negative control series for this intervention (be specific), and justify your selections. Explain in your own words how a negative control series helps with inference.

An appropriate control would be the homicide rate from a different US state that did not introduce graduated licensing around this time (such as New York, Texas, Ohio, or Virginia). Ideally, the negative control should be as similar as possible to the population of interest, except that they were not targeted by or exposed to the intervention. An alternative negative control would be another outcome not targeted by the law, such as firearm suicides in Florida. In the paper by Humphreys et al, they used both of these negative controls: https://jamanetwork-com/journals/jamainternalmedicine/fullarticle/2582988

One of the challenges of interrupted time series is that there may be other confounding factors that led to a change in the homicide rate, such as co-occurring interventions around the same time as the introduction of the Stand-your-ground law, which may have been responsible for the change in the homicide rate (e.g., other laws or regulations that made firearms easier to obtain). The first step for making use of a negative control series is to evaluate whether there were any changes in this series at the time of the Stand-your-ground law in October 2005. If we did observe a change in the control series that is similar in magnitude to the change observed in the intervention series, this tells us that there is something else causing the change, rather than the introduction of the Stand-your-ground law. Thus, we cannot say with certainty that the observed changes were due to the law. On the other hand, if we observed no change in the negative control series, this provides stronger evidence that the change in the homicide rate was due to the Stand-your-ground law.
