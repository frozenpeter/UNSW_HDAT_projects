---
title: "HDAT9600 Final Team Assignment"
subtitle: "Please see course timetable / 'Announcements' for submission deadline"
author: "Team 3: Zhenyu"
date: "insert date of completion here"
output: html_document
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)

## required packages for examples 
libs <- c("eha", "stringi", "bshazard", "survminer")
missing <- !libs %in% installed.packages()
if (any(missing)) {
  install.packages(libs[missing],repos="https://cloud.r-project.org")
}


library(bshazard)
library(car)
library(caret)
library(DescTools)
library(eha)
library(dplyr)
library(flexsurv)
library(ggplot2)
library(ggplot2)
library(knitr)
library(MASS)
library(muhaz)
library(pch)
library(pROC)
library(ROCR)
library(stringi)
library(survminer)
library(survival)
library(tidyr)

```

## Instructions

* This file (hdat9600assess4_teamX.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final team assignment.
* You should rename the file by replacing 'X' with your team number.
* This assignment is assessed and will count for 30% of the total course marks.
* The assignment comprises two tasks. The first task will focus on building a model to PREDICT an outcome and the second task will focus on using a model to EXPLAIN the relationships between a variable of interest and the outcome.
* There is no word limit, nor limit on the length of your submitted Rmarkdown (i.e. this file) document. However, the **rendered** html document, were it to be printed, should be **no more** than about 10 A4 pages in length. 
* Your html rendered document should include sufficient code chunks, output, and visual display as necessary to support your discursive commentary addressing each task. You may therefore wish to **suppress some of the contents** of your Rmarkdown file from appearing within the rendered document to ensure your output focuses on the most relevant results and discussion to address the questions.
* The rendered (html) document will be the submission primarily considered when awarding credit. However, the Rmarkdown file may also be considered if required to understand the analysis.
* <strong> Excessively long reports will be penalised </strong> by cessation of awarding of credit after roughly 10 pages of content.
* Feel free to delete the assignment instructions as you see fit to allow you some more room. 
* All tasks are intended to be completed as a team. Have fun discussing the tasks and working together.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor is happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assessment for you!


## Data for this assessment

The data used for this assessment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assessment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. The original data has been modified and assembled to suit the purpose of this assessment. 

The dataframe consists of 120 variables, which are defined as follows:

#### Patient Descriptor Variables
<li> <em>RecordID:</em>            a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patientâ€™s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


#### Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


#### Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

* SAPS-I score - Simplified Acute Physiological Score [Le Gall et al., 1984](http://www.ncbi.nlm.nih.gov/pubmed/6499483)
* SOFA score - Sequential Organ Failure Assessment [Ferreira et al., 2001](http://www.ncbi.nlm.nih.gov/pubmed/11594901)

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

* [Albumin](http://en.wikipedia.org/wiki/Human_serum_albumin)
 (g/dL)
* [ALP](http://en.wikipedia.org/wiki/Alkaline_phosphatase)
 [Alkaline phosphatase (IU/L)]
* [ALT](http://en.wikipedia.org/wiki/Alanine_transaminase)
 [Alanine transaminase (IU/L)]
* [AST](http://en.wikipedia.org/wiki/Aspartate_transaminase)
 [Aspartate transaminase (IU/L)]
* [Bilirubin](http://en.wikipedia.org/wiki/Bilirubin)
 (mg/dL)
* [BUN](http://en.wikipedia.org/wiki/BUN)
 [Blood urea nitrogen (mg/dL)]
* [Cholesterol](http://en.wikipedia.org/wiki/Cholesterol)
 (mg/dL)
* [Creatinine](http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine)
 [Serum creatinine (mg/dL)]
* [DiasABP](http://en.wikipedia.org/wiki/Diastolic_blood_pressure)
 [Invasive diastolic arterial blood pressure (mmHg)]
* [FiO2](http://en.wikipedia.org/wiki/FIO2)
 [Fractional inspired O<sub>2</sub> (0-1)]
* [GCS](http://en.wikipedia.org/wiki/Glasgow_coma_score)
 [Glasgow Coma Score (3-15)]
* [Glucose](http://en.wikipedia.org/wiki/Serum_glucose)
 [Serum glucose (mg/dL)]
* [HCO3](http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics)
 [Serum bicarbonate (mmol/L)]
* [HCT](http://en.wikipedia.org/wiki/Hematocrit)
 [Hematocrit (%)]
* [HR](http://en.wikipedia.org/wiki/Heart_rate)
 [Heart rate (bpm)]
* [K](http://en.wikipedia.org/wiki/Hypokalemia)
 [Serum potassium (mEq/L)]
* [Lactate](http://en.wikipedia.org/wiki/Lactic_acid)
 (mmol/L)
* [Mg](http://en.wikipedia.org/wiki/Magnesium#Biological_role)
 [Serum magnesium (mmol/L)]
* [MAP](http://en.wikipedia.org/wiki/Mean_arterial_pressure)
 [Invasive mean arterial blood pressure (mmHg)]
* [MechVent](http://en.wikipedia.org/wiki/Mechanical_ventilation)
 [Mechanical ventilation respiration (0:false, or 1:true)]
* [Na](http://en.wikipedia.org/wiki/Serum_sodium)
 [Serum sodium (mEq/L)]
* [NIDiasABP](http://en.wikipedia.org/wiki/Diastolic_blood_pressure)
 [Non-invasive diastolic arterial blood pressure (mmHg)]
* [NIMAP](http://en.wikipedia.org/wiki/Mean_arterial_pressure)
 [Non-invasive mean arterial blood pressure (mmHg)]
* [NISysABP](http://en.wikipedia.org/wiki/Systolic_blood_pressure)
 [Non-invasive systolic arterial blood pressure (mmHg)]
* [PaCO2](http://en.wikipedia.org/wiki/Arterial_blood_gas)
 [partial pressure of arterial CO<sub>2</sub> (mmHg)]
* [PaO2](http://en.wikipedia.org/wiki/Arterial_blood_gas)
 [Partial pressure of arterial O<sub>2</sub> (mmHg)]
* [pH](http://en.wikipedia.org/wiki/Arterial_blood_gas)
 [Arterial pH (0-14)]
* [Platelets](http://en.wikipedia.org/wiki/Platelets)
 (cells/nL)
* [RespRate](http://en.wikipedia.org/wiki/Respiratory_physiology)
 [Respiration rate (bpm)]
* [SaO2](http://en.wikipedia.org/wiki/Arterial_blood_gas)
 [O<sub>2</sub> saturation in hemoglobin (%)]
* [SysABP](http://en.wikipedia.org/wiki/Systolic_blood_pressure)
 [Invasive systolic arterial blood pressure (mmHg)]
* [Temp](http://en.wikipedia.org/wiki/Normal_human_body_temperature)
 [Temperature (&deg;C)]
* [TropI](http://en.wikipedia.org/wiki/Troponin)
 [Troponin-I (&mu;g/L)]
* [TropT](http://en.wikipedia.org/wiki/Troponin)
 [Troponin-T (&mu;g/L)]
* [Urine](http://en.wikipedia.org/wiki/Fluid_balance)
 [Urine output (mL)]
* [WBC](http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology)
 [White blood cell count (cells/nL)]
* Weight (kg)


## Accessing the Data
There are two datasets provided. The data frames can be loaded with the following code:

```{r task0 read and check}
mydat <- file.path("C:/Users/froze/OneDrive/Documents/2.1 UNSW bioinfo/HDAT9600/Assignment/Group/HDAT9600_Assign4_GroupProject")

icu_patients_df0 <- readRDS(file.path(mydat,"icu_patients_df0.rds"))
icu_patients_df1 <- readRDS(file.path(mydat,"icu_patients_df1.rds"))
#summary(icu_patients_df1) #check  data frame structure
#str(icu_patients_df1)
#glimpse(icu_patients_df1) #quickly see the entirety of the data frame's structure and less likely to truncate

# Calculate the number of missing values for each column
missing_values <- colSums(is.na(icu_patients_df1))
# Remove the variables that do not have missing values
missing_values <- missing_values[missing_values > 0]
# Print the variables with their count of missing values
print(missing_values)
```

**Note:** icu_patients_df1 is an imputed (i.e. missing values are 'derived') version of icu_patients_df0.  This assessment does not concern the methods used for imputation. You should use `icu_patients_df1` for all tasks unless it is specifically noted to use `icu_patients_df0`. 

From the output and combined with reference papers, here are some variables that correspond to the SAPS-I and SOFA scores and could be considered important for the models:
1. **SAPS-I score**: The dataset includes SAPS1 as a variable, which is directly relevant.
2. **SOFA score**: The dataset includes SOFA as a variable, also directly relevant.
3. **Respiratory function**: PaO2/FiO2 ratio (part of SOFA), and Respiratory rate (part of SAPS-I). In the dataset, PaO2, FiO2 and RespRate variables could be related to respiratory function (not find MechVent variable).
4. **Coagulation**: Platelets count is directly mentioned in the dataset and SOFA.
5. **Liver function**: Bilirubin levels are included in both the dataset and the SOFA score.
6. **Cardiovascular system**: The presence of hypotension and administration of dopamine or dobutamine are factors in the SOFA score. In the dataset, variables like MAP, SysABP, and NIMAP are related to blood pressure and might be used as proxies.
7. **Central nervous system**: Glasgow Coma Score is present in both the SOFA and SAPS-I scores and directly available in the dataset (GCS variables).
8. **Renal function**: Creatinine levels and Urine output, which are in SOFA and indirectly in SAPS-I (blood urea), correspond to Creatinine and Urine variables in the data.
9. **Age**: This is explicitly mentioned in SAPS-I and is a known risk factor in ICU outcomes. The Age variable is available in the dataset.

Considering these variables for inclusion in the predictive models for Task 1 (Logistic Regression for in-hospital death) and Task 2 (Survival Analysis for length of survival) would be reasonable based on their clinical importance and representation in established severity scores.

**Variables with Missing Data:**
- `SAPS1`: 96 missing values (4.66% missing) - This is a relatively small proportion of the dataset. Since SAPS-I is an important score for ICU prognosis, it might be worth imputing these values rather than excluding the variable.
- `Survival`: 1,288 missing values (62.48% missing) - This is a significant amount of missing data. However, 'Survival' may represent censored data rather than simply missing information. In survival analysis, this would be the expected setup, where patients who did not die in the hospital are censored at the last follow-up time.
- Blood pressure-related variables (`DiasABP_diff`, `DiasABP_max`, `DiasABP_min`, `NIDiasABP_diff`, `NIDiasABP_max`, `NIDiasABP_min`, `NIMAP_diff`, `NIMAP_max`, `NIMAP_min`, `NISysABP_diff`, `NISysABP_max`, `NISysABP_min`, `SysABP_diff`, `SysABP_max`, `SysABP_min`): All these have a high degree of missingness, ranging from 21.98% to 34.54%. Since these are many related variables with substantial missing data, we might consider/test the importance of blood pressure measurement in your analysis and whether it could be captured by fewer variables (maybe only MAP).
- `Height`: 992 missing values (48.10% missing) - If height is not central to analysis and considering the high rate of missingness, it could be a candidate for exclusion.
- Weight-related variables (`Weight_diff`, `Weight_max`, `Weight_min`): 146 missing values (7.08% missing) - This is a smaller proportion of missing data and might be worth imputing if weight is considered important in analysis.


```{r task0_data clean (optional)}
# Set a threshold for maximum acceptable proportion of missing data
missing_threshold <- 0.5
# Calculate the proportion of missing data for each variable
prop_missing <- colSums(is.na(icu_patients_df1)) / nrow(icu_patients_df1)
# Identify variables to exclude based on the threshold
vars_to_exclude <- names(prop_missing[prop_missing > missing_threshold])
# Identify variables to impute
vars_to_impute <- names(prop_missing[prop_missing <= missing_threshold & prop_missing > 0])
# Make a copy of the data frame to clean
icu_patients_df1_cleaned <- icu_patients_df1
# Impute missing values for selected variables using median
for(var in vars_to_impute) {
  icu_patients_df1_cleaned[[var]][is.na(icu_patients_df1_cleaned[[var]])] <- median(icu_patients_df1_cleaned[[var]], na.rm = TRUE)
}
# Now exclude the variables with too much missing data from the cleaned dataframe
icu_patients_df1_cleaned <- icu_patients_df1_cleaned[ , !(names(icu_patients_df1_cleaned) %in% vars_to_exclude)]

# Check if there is any missing vcalues
missing_values <- colSums(is.na(icu_patients_df1_cleaned))
missing_values <- missing_values[missing_values > 0]
print(missing_values)
```
## Aims of your project

You have two analytic goals in this assignment. 
1. The first goal (Task 1) is to build a model to PREDICT in-hospital death. The context for this is that the hospital management wishes to use this model to prioritise the allocation of resources with the overarching aim of improving patient survival.  
2. The second goal (Task 2) is to try to understand and EXPLAIN how survival varies by `Age`. How does survival change with increasing Age? Are age-related survival differences explained solely by differing clinical characteristics of patients? 


# Task 1

### Part A: Exploratory data analysis

Conduct a brief EDA for the dataset `icu_patients_df1`. One of your goals for this EDA should be to identify a sub-set of variables (approx 15-20 variables) that _may_ be useful predictors of survival and/or relevant to your analytical task. You may wish to firstly undertake a brief literature review to try to identify factors that may be important predictors of survival in an ICU. This doesn't need to be in-depth, but enough to get a basic idea of what the variables are measuring and which variables might, in theory, be most important. 

For the 15-20 chosen variables, present enough information to: (i) explain why you selected these variables, based on a combination of your literature review and EDA, and (ii) Provide an overview of the variables and how they are related to `in-hospital death`. Present your summary using tables and/or plots with supporting commentary where relevant. 

```{r task1.A_1 Demographics summary}
# Overall Demographics Summary
overall_demo <- summary(icu_patients_df1[c("Age", "Height", "Weight_max", "Weight_min", "SOFA", "SAPS1")])
kable(overall_demo, caption = "Overall Demographics Summary", format = "markdown")

# Split the dataset into survivors and non-survivors
survivors_df <- icu_patients_df1[icu_patients_df1$in_hospital_death == 0, ]
deceased_df <- icu_patients_df1[icu_patients_df1$in_hospital_death == 1, ]

# Summary for Survivors
survivors_demo <- summary(survivors_df[c("Age", "Weight_max", "Weight_min", "Length_of_stay", "SOFA", "SAPS1")])
kable(survivors_demo, caption = "Demographics Summary for Survivors", format = "markdown")

# Summary for Non-Survivors
deceased_demo <- summary(deceased_df[c("Age", "Weight_max", "Weight_min", "Length_of_stay", "Survival", "SOFA", "SAPS1")])
kable(deceased_demo, caption = "Demographics Summary for Non-Survivors", format = "markdown")


# Create a table for Gender Distribution, Number of in hospital Deaths, and ICU Types
# Calculate the required numbers and percentages
patients_count <- nrow(icu_patients_df1)
gender_counts <- table(icu_patients_df1$Gender)
gender_percentages <- prop.table(gender_counts) * 100
death_counts <- sum(icu_patients_df1$in_hospital_death, na.rm = TRUE)
death_percentage <- (death_counts / patients_count) * 100
icu_type_counts <- table(icu_patients_df1$ICUType)
icu_type_percentages <- prop.table(icu_type_counts) * 100

# Create a data frame with the calculated values
demographics_table <- data.frame(
  Category = c("Number_of_Patients",
               "Gender: Male",
               "Gender: Female",
               "in_hospital_death",
               "ICU Types: Coronary Care Unit",
               "ICU Types: Cardiac Surgery Recovery Unit",
               "ICU Types: Medical ICU",
               "ICU Types: Surgical ICU"),
  Number = c(patients_count,
             gender_counts["Male"],
             gender_counts["Female"],
             death_counts,
             icu_type_counts["Coronary Care Unit"],
             icu_type_counts["Cardiac Surgery Recovery Unit"],
             icu_type_counts["Medical ICU"],
             icu_type_counts["Surgical ICU"]),
  Percentage = c(NA,  # Placeholder for total patients percentage
                 gender_percentages["Male"],
                 gender_percentages["Female"],
                 death_percentage,
                 icu_type_percentages["Coronary Care Unit"],
                 icu_type_percentages["Cardiac Surgery Recovery Unit"],
                 icu_type_percentages["Medical ICU"],
                 icu_type_percentages["Surgical ICU"])
)

# Use kable to print the table
kable(demographics_table, caption = "Demographics Summary 2", align = c('l', 'r', 'r'), format = "markdown")

```
**Overall Demographics Summary:**
- Patients range in age from 16 to 90, with a median age of 67, suggesting a predominantly older patient population.
- Height varies widely, with some extreme values (min 13 cm, max 426.7 cm), indicating possible data entry errors, given the maximum height is biologically implausible.
- The max weight of patients (Weight_max) and minimum weight (Weight_min) during the stay are similar in range, indicating relatively stable weight during ICU stay or uniformity in recording practices.
- SOFA scores, which range from -1 to 22, with a mean of 6.441, indicate varying degrees of organ failure severity among patients.
- SAPS1 scores also show a wide range, but there are missing values for SAPS1 that may need addressing for complete analysis.

**Demographics Summary for Survivors and Non-Survivors:**
- Survivors have a slightly lower mean age (63.29) compared to the overall (64.41) and non-survivor (71.05) groups, and the length of stay varies from -1 (which could be an error) to 154 days.
- A small number of survivors have maximum and minimum weights at the upper limit of 230 kg, which may be outliers or may represent a small subset of critically ill patients with a higher body weight.
- The median and mean weights for non-survivors are slightly lower than for survivors, which could reflect severe illness trajectories that may affects body weight. However, in general, the distribution of weight data does not indicate dramatic differences between survivors and non-survivors.
- The median and average SOFA and SAPS1 scores among survivors is lower than non-survivors, which aligns with the understanding that higher scores are associated with more severe organ dysfunction and a higher likelihood of mortality.

**Demographics Table Summary 2:**
- There were 2061 patients in total, with a higher proportion of males (approximately 55.70%) compared to females.
- The proportion of patients who died in the hospital was about 14.41%.
- The distribution of patients across ICU types shows the largest number in the Medical ICU (38.23%) and the least in the Coronary Care Unit (14.41%).


```{r task1.A_2 Plotting distributions of a variable}
# Add a descriptive label for in-hospital death status
icu_patients_df1$Status_Label <- ifelse(icu_patients_df1$in_hospital_death == 0, "Survived", "Died")
icu_patients_df1$Status_Label <- as.factor(icu_patients_df1$Status_Label)

# Create a list of demographic variables to plot
demographic_vars <- c("Age", "Height", "Weight_max", "Weight_min", "Length_of_stay", "Survival")

# Create a series of plots for each demographic variable
plots <- lapply(demographic_vars, function(var) {
  ggplot(icu_patients_df1, aes_string(x = var, fill = "Status_Label")) +
    geom_histogram(position = "dodge", binwidth = 5, na.rm = TRUE) +
    labs(x = var, y = "Count") +
    scale_fill_brewer(palette = "Set1", name = "Outcome") +
    theme_minimal() +
    ggtitle(paste("Distribution of", var, "by In-Hospital Death Status"))
})

# Print the plots
print(plots[[1]]) # For Age
print(plots[[2]]) # For Height
print(plots[[3]]) # For Weight_max
print(plots[[4]]) # For Weight_min
print(plots[[5]]) # For Length_of_stay
print(plots[[6]]) # For Survival


```
For the `Height` which < 17.8 or > 365 should be error on data collection or recording

```{r task1.A_3 Correct the 'Height' variable}
# Correct the 'Height' variable by setting values outside the range 50 to 250 to NA
icu_patients_df1_h <- icu_patients_df1
icu_patients_df1_h$Height <- ifelse(icu_patients_df1_h$Height < 50 | icu_patients_df1_h$Height > 250, NA, icu_patients_df1_h$Height)

# Recheck the summary for Height in the new dataframe and reprint the plot
summary(icu_patients_df1_h$Height)

plots2 <- lapply(demographic_vars, function(var) {
  ggplot(icu_patients_df1_h, aes_string(x = var, fill = "Status_Label")) +
    geom_histogram(position = "dodge", binwidth = 5, na.rm = TRUE) +
    labs(x = var, y = "Count") +
    scale_fill_brewer(palette = "Set1", name = "Outcome") +
    theme_minimal() +
    ggtitle(paste("Distribution of", var, "by In-Hospital Death Status"))
})

print(plots2[[2]])
```
**Histograms of the distribution of patient demographics**
- Age Distribution: There is a noticeable increase in the count of younger patients who survived compared to those who did not, with survival rates decreasing as age increases. Particularly, the survival rate is significantly lower for patients aged above 70.
- Height Distribution: The distribution of height shows a fairly normal range with most individuals between 150 and 200 cm. A few outliers below 150 cm may require verification for accuracy. The survival seems independent of height as both survived and died groups are similarly distributed.
- Maximum &  Minimum Weight Distribution: The weight of patients is concentrated around 50 to 100 kg. This indicates that extreme weights are not common among patients. The survival seems not too much dependent of the patientâ€™s weight.
- Length of Stay: The majority of patients had a shorter length of stay in the ICU. The survival seems independent of the number of days between the patientâ€™s admission to the ICU and the end of hospitalisation as both survived and died groups are similarly distributed.
- Survival Days: The survival days histogram is heavily skewed, with most patients surviving fewer days. The high number of patients with 0 survival days may indicate a significant number of deaths occurring shortly after admission to the ICU.

### Part B: Predictive logistic model

Your aim is to build a model to PREDICT in-hospital death. In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately **predicts** the `in_hospital_death` variable as the outcome and utilises predictor variables from your chosen subset. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small selection of them, which you have selected based on statistical significance and/or background knowledge. Remember, your aim is prediction, but you should also consider generalisability of the model, so we are aiming for parsimony. Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of relevant diagnostic statistics and/or charts and comment on them. 

Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


**Create your response to task 1 here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text. Add code chunks as you see fit and choose whether you wish for the code and or results to be displayed in the final html document.** 

```{R task1.B_0 check SAPS1 and SOFA as reference}
# Exclude observations where SAPS1 is NA as SAPS1 has 96 missing values
valid_data <- icu_patients_df1[!is.na(icu_patients_df1$SAPS1), ]

# Logistic regression to see the effect of SAPS1 and SOFA scores on in-hospital death
model_saps1 <- glm(in_hospital_death ~ SAPS1, data = valid_data, family = binomial)
model_sofa <- glm(in_hospital_death ~ SOFA, data = valid_data, family = binomial)

# Summary of logistic regression models
summary(model_saps1)
summary(model_sofa)

# Predicted probabilities for the models
pred_saps1 <- predict(model_saps1, type = "response")
pred_sofa <- predict(model_sofa, type = "response")

# Create prediction objects for ROC analysis
pred_obj_saps1 <- prediction(pred_saps1, valid_data$in_hospital_death)
pred_obj_sofa <- prediction(pred_sofa, valid_data$in_hospital_death)

# Create performance objects for ROC analysis
perf_saps1 <- performance(pred_obj_saps1, "tpr", "fpr")
perf_sofa <- performance(pred_obj_sofa, "tpr", "fpr")

# Plot ROC curves
plot(perf_saps1, col = "red", main = "ROC Curves for SAPS1 and SOFA Models")
plot(perf_sofa, col = "blue", add = TRUE)
abline(a = 0, b = 1, lty = 2)

# Add a legend
legend("bottomright", legend = c("SAPS1 Model", "SOFA Model"), col = c("red", "blue"), lwd = 2)

# Calculate AUC for SAPS1 model
auc_saps1 <- performance(pred_obj_saps1, measure = "auc")
auc_saps1_value <- auc_saps1@y.values[[1]]
cat("AUC for SAPS1 Model:", auc_saps1_value, "\n")

# Calculate AUC for SOFA model
auc_sofa <- performance(pred_obj_sofa, measure = "auc")
auc_sofa_value <- auc_sofa@y.values[[1]]
cat("AUC for SOFA Model:", auc_sofa_value, "\n")

```
These models provide a baseline for what can be expected when using SAPS1 and SOFA scores to predict in-hospital mortality
For the **SAPS1 model**:
- The coefficient for SAPS1 is 0.12558 with a p-value < 2e-16, indicating a statistically significant association with in-hospital death. The positive sign indicates that higher SAPS1 scores are associated with an increased probability of in-hospital death.
- The model has an AIC of 1534.8, which can be used to compare the relative quality of statistical models for a given dataset.

For the **SOFA model**:
- The coefficient for SOFA is 0.13540 with a p-value < 2e-16, which is also statistically significant. Similar to SAPS1, a higher SOFA score is associated with a higher probability of in-hospital death.
- The AIC for this model is slightly higher at 1555, suggesting that the SAPS1 model might fit the data slightly better when considering only these scores as predictors.


**residual deviance**: The smaller the residual deviance, the better the model fits.
- SAPS1 model has 1530.8 residual deviance on 1963 degrees of freedom
- SOFA model has 1551 residual deviance on 1963 degrees of freedom

**ROC analysis**: The closer the ROC curve is to the top left corner, the higher the overall accuracy of the test. In this case, the SAPS1 model's ROC curve (in red) is closer to the top left corner than the SOFA model's curve (in blue), showing it performs better in your dataset for predicting the outcome.In addition, the SAPS1 model has a higher area under the curve (AUC), confirming its stronger predictive performance compared to the SOFA model in your dataset.
- The SAPS1 model has an AUC of 0.6733918, which suggests it has a fair predictive power. Generally, an AUC close to 0.7 is considered acceptable, but there's room for improvement.
- The SOFA model has an AUC of 0.6392481, which is slightly lower than SAPS1, indicating it is less predictive of in-hospital mortality compared to the SAPS1 model in your dataset.


_Alternative variables_
From the previous outputs and reference papers, here are some variables that be considered important for the Regression models:
1. **SAPS-I score**: The dataset includes SAPS1 as a variable, which is directly relevant
2. **SOFA score**: The dataset includes SOFA as a variable, also directly relevant
3. **Respiratory function**: PaO2, FiO2 and RespRate
4. **Coagulation & blood**: Platelets, pH, Glucose
5. **Liver function**: Bilirubin, Albumin, ALP, ALT, AST
6. **Cardiovascular system**: HR, MAP, TroponinI, TroponinT, Lactate 
7. **Central nervous system**:GCS
8. **Renal function**: Creatinine, Urine
9. **immune system**: Temp, WBC
10.**Age**: Age

Building separate logistic regression models for each system (like respiratory, coagulation & blood, cardiovascular, etc.) can be a good approach to understand which variables within each system are most predictive of in-hospital death. 
Here's a structured approach to building these models:

1. Respiratory Function Model: Use variables like PaO2_max, FiO2_max, and RespRate_max to reflect the most extreme states that may have critical implications for patient outcomes.
2. Coagulation & Blood Model: Platelets_max, pH_min, pH_max, and Glucose_max could be used to capture the most critical levels that may reflect acute events or stress responses.
3. Liver Function Model: Bilirubin_max, Albumin_min, ALP_max, ALT_max, and AST_max might be chosen to reflect liver function and injury.
4. Cardiovascular System Model: HR_max, MAP_max, TroponinI_max, and TroponinT_max, Lactate_max, Cholesterol_max can be indicators of cardiovascular stability and myocardial injury.
5. Central Nervous System Model: The GCS_min could be used as it represents the lowest level of consciousness.
6. Renal Function Model: Creatinine_max and Urine_min could be selected to reflect renal impairment or failure.
7. Immune System Model: Temp_max and WBC_max could reflect the highest levels of inflammatory response.
8. General Model: Incorporate variables like Age, Gender, weight, ICUType are broadly representative of patients' status.

Once these models are built
1. Could compare them to determine which system's variables are the strongest predictors. 
2. Could build a combined model with the best predictors from each system.

```{R task1.B_1 test other potential variables could improve the predictive power}
# Respiratory Function Model
resp_model <- glm(in_hospital_death ~ PaO2_max + FiO2_max + RespRate_max, 
                  family = binomial(link = 'logit'), data = icu_patients_df1_h)
summary(resp_model)

# Coagulation & Blood Model
coag_model <- glm(in_hospital_death ~ Platelets_max + pH_min + pH_max + Glucose_max, 
                  family = binomial(link = 'logit'), data = icu_patients_df1_h)
summary(coag_model)

# Cardiovascular System Model
cardio_model <- glm(in_hospital_death ~ HR_max + MAP_max + TroponinI_max + TroponinT_max + Lactate_max +Cholesterol_max, 
                    family = binomial(link = 'logit'), data = icu_patients_df1_h)
summary(cardio_model)

# Central Nervous System Model
cns_model <- glm(in_hospital_death ~ GCS_min, 
                 family = binomial(link = 'logit'), data = icu_patients_df1_h)
summary(cns_model)

# Renal Function Model
renal_model <- glm(in_hospital_death ~ Creatinine_max + Urine_min, 
                   family = binomial(link = 'logit'), data = icu_patients_df1_h)
summary(renal_model)

# Immune System Model
immune_model <- glm(in_hospital_death ~ Temp_max + WBC_max, 
                    family = binomial(link = 'logit'), data = icu_patients_df1_h)
summary(immune_model)

# General Model
  # Trans 'Gender' and 'ICUType' as factors
icu_patients_df1_h$Gender <- as.factor(icu_patients_df1_h$Gender)
icu_patients_df1_h$ICUType <- as.factor(icu_patients_df1_h$ICUType)
  # Creat General Model
general_model <- glm(in_hospital_death ~ Age + Gender + Weight_max + ICUType, 
                       family = binomial(link = 'logit'), 
                       data = icu_patients_df1_h)
summary(general_model)
```
_model summaries:_
1. In the Respiratory Function Model, PaO2_max and RespRate_max are significant predictors. FiO2_max is not statistically significant, which means it might not be a strong predictor for the outcome in this model.
2. For the Coagulation & Blood Model, pH_min and Glucose_max are significant, while pH_max is not. This suggests that low blood pH (Acidosis ) and glucose levels could be important predictors for in-hospital death.
3. The Cardiovascular System Model shows that Lactate_max and Cholesterol_max have a significant relationship with the outcome. HR_max, MAP_max, TroponinI_max, and TroponinT_max did not reach statistical significance, although TroponinT_max is close and could be considered for inclusion in a more comprehensive model.
4. In the Central Nervous System Model, GCS_min is a significant predictor. This aligns with medical knowledge, as a lower Glasgow Coma Score is associated with higher severity of disease.
5. For the Renal Function Model, both Creatinine_max and Urine_min are significant. This suggests that worse renal function is associated with a higher risk of in-hospital death.
6. The Immune System Model indicates that WBC_max is significant, but Temp_max is not. This could suggest that a higher white blood cell count, which might indicate infection or inflammation, is more predictive of in-hospital death than the maximum temperature.
7. Finally, the Demographics Model with Age, Gender, Weight, and ICUType shows that Age and ICUType (specifically, the Cardiac Surgery Recovery Unit and Medical ICU) are significant predictors. Gender and Weight_max do not appear to contribute significantly to this model.

If a predictor like `PaO2_max` has a very small estimate (-0.0020090) and a high p-value, it might be dropped in favor of keeping the model simpler and more interpretable, unless there is a strong clinical reason to keep it.

Based on these observations, a model aiming for parsimony and generalizability could include the following variables:

name	Estimate 	Std. Error 	z value	Pr(>|z|) 	Signif.
PaO2_max	-0.002009	0.0005988	-3.355	7.94E-04	***
RespRate_max	0.034408	0.0075397	4.564	5.03E-06	***
pH_min	-2.5456808	0.7066192	-3.603	0.000315	***
Glucose_max	0.0020872	0.0005909	3.532	0.000412	***
Lactate_max	0.1403429	0.0272981	5.141	2.73E-07	***
Cholesterol_max	-0.0076152	0.0016589	-4.591	4.42E-06	***
GCS_min	-0.04514	0.01317	-3.426	0.000612	***
Creatinine_max	0.157655	0.031742	4.967	6.81E-07	***
Urine_min	-0.005531	0.001732	-3.193	0.00141	**
WBC_max	0.014721	0.006865	2.144	0.032	*
Age	0.0328361	0.0045562	7.207	5.72E-13	***

Base on `Estimate` values we could try three different style models

```{R task1.B_2 Building three types of Models}
# Creating simplest model
simplest_model <- glm(in_hospital_death ~ pH_min + Lactate_max + GCS_min + Creatinine_max + Age, 
                       family = binomial(link = "logit"), data = icu_patients_df1_h)
summary(simplest_model)

# Creating parsimony model
parsimony_model <- glm(in_hospital_death ~ RespRate_max + pH_min + Lactate_max + GCS_min + Creatinine_max + WBC_max + Age, 
                       family = binomial(link = "logit"), data = icu_patients_df1_h)
summary(parsimony_model)

# Creating intact model with all significant predictors
intact_model <- glm(in_hospital_death ~ PaO2_max + RespRate_max + pH_min + Glucose_max + Lactate_max + Cholesterol_max + GCS_min + Creatinine_max + Urine_min + WBC_max + Age, 
                    family = binomial(link = "logit"), data = icu_patients_df1_h)
summary(intact_model)


ICUType_model <- glm(in_hospital_death ~ ICUType, 
                       family = binomial(link = 'logit'), 
                       data = icu_patients_df1_h)
summary(ICUType_model)

```

### Simplest Model
- This model includes both biochemical markers and patient characteristics. 
- **pH_min**: Indicates the minimum pH level; a lower pH is significant and suggests acidosis, which is clinically relevant to patient outcomes.
- **Lactate_max**: Elevated lactate is highly significant and associated with worse outcomes, which is consistent with clinical expectations of lactic acidosis being a sign of severe stress or hypoxia.
- **GCS_min**: Lower minimum Glasgow Coma Scale scores, indicating poorer neurological function, are significantly associated with a higher risk of death.
- **Creatinine_max**: Higher creatinine levels are associated with kidney dysfunction, also a significant predictor of mortality.
- **Age**: Older age remains a significant predictor, with each year increasing risk.
This model has an AIC of 1583, which indicates a good fit to the data.
- Note: Lower AIC (Akaike Information Criterion) values indicate a better fit.

### Parsimony Model
- This model adds respiratory rate and white blood cell count to the previous model's predictors.`pH_min` become marginal.
- **RespRate_max**: Increased respiratory rate is significantly associated with higher mortality, aligning with clinical expectations where tachypnea can indicate respiratory distress.
- **WBC_max**: Higher white blood cell counts are typically indicative of infection or inflammation, but in this model, it is not significant.
This model has an AIC of 1574.2, which is slightly lower than the first model, suggesting it may fit the data a bit better despite the addition of a non-significant predictor.

### Intact Model
- This model includes all the selected predictors. `pH_min` become significant again.
- **PaO2_max**: This variable is significantly negative, meaning higher maximum PaO2 levels are associated with reduced risk, possibly due to effective oxygenation.
- **Glucose_max**: Elevated maximum glucose levels, likely indicating hyperglycemia, are significantly associated with increased mortality risk. This aligns with clinical observations where severe hyperglycemia can be a marker of acute illness stress or poor glycemic control.
- **Cholesterol_max**: Interestingly, maximum cholesterol levels have a significant negative association with mortality risk. This counterintuitive finding may require clinical interpretation. One possible explain is cholesterol levels can drop in acute illness, especially with systemic inflammation.
- **Urine_min**: Lower urine output is traditionally associated with poor outcomes, but it is not significant in this model.
This model's AIC is 1537.8, the lowest of the three models, suggesting the best fit among them despite including some non-significant predictors.


```{R task1.B_3 Comparing models}
# Exclude observations where SAPS1 is NA as SAPS1 has 96 missing values
valid_data <- icu_patients_df1[!is.na(icu_patients_df1$SAPS1), ]
# Comparing models with ANOVA
model_saps1 <- glm(in_hospital_death ~ SAPS1, data = valid_data, family = binomial)
model_sofa <- glm(in_hospital_death ~ SOFA, data = valid_data, family = binomial)
# Creating models with valid_data again
simplest_model_v <- glm(in_hospital_death ~ pH_min + Lactate_max + GCS_min + Creatinine_max + Age, 
                       family = binomial(link = "logit"), data = valid_data)

parsimony_model_v <- glm(in_hospital_death ~ RespRate_max + pH_min + Lactate_max + GCS_min + Creatinine_max + WBC_max + Age, 
                       family = binomial(link = "logit"), data = valid_data)

intact_model_v <- glm(in_hospital_death ~ PaO2_max + RespRate_max + pH_min + Glucose_max + Lactate_max + Cholesterol_max + GCS_min + Creatinine_max + Urine_min + WBC_max + Age, 
                    family = binomial(link = "logit"), data = valid_data)

anova_results <- anova(model_saps1, model_sofa, simplest_model_v, parsimony_model_v, intact_model_v, test = "Chisq")
print(anova_results)

```
**The `Pr(>Chi)` column indicates**: the p-value for a chi-squared test, comparing each model with the one before it. Statistically significant p-values suggest that the model has improved with the addition of more variables. The final model (Model 5) has the lowest Residual Deviance and AIC, which suggests it is the best-fitting model of those tested. However, the principle of parsimony suggests choosing the simplest model that still provides an adequate fit. Thus a balance needs to be found.

```{R task1.B_4 two-way interaction model from parsimony model}
# Creating two-way interaction models from previous models
two_way_interaction_simplest_model <- update(simplest_model, . ~ .^2)
two_way_interaction_parsimony_model <- update(parsimony_model, . ~ .^2)
two_way_interaction_intact_model <- update(intact_model, . ~ .^2)

# Dropping each two-way interaction term to test significance
drop_interaction_result_simplest <- drop1(two_way_interaction_simplest_model, test = "Chisq")
drop_interaction_result_simplest

drop_interaction_result_parsimony <- drop1(two_way_interaction_parsimony_model, test = "Chisq")
drop_interaction_result_parsimony

drop_interaction_result_intact <- drop1(two_way_interaction_intact_model, test = "Chisq")
drop_interaction_result_intact
```
_Results of two-way interactions_
1. Most interaction terms do not significantly improve the model (indicated by high p-values), which implies that the main effects of the predictors are sufficient for the prediction.
2. A few interaction terms do show significance (indicated by low p-values), which might suggest that the relationship between predictors and the in_hospital_death is more complex than additive. Notably:
3. considering the inclusion of interaction terms, it is essential to evaluate their clinical relevance and the potential for overfitting. Models with too many interactions, especially in smaller datasets, can fit the noise in the data rather than the underlying relationships, leading to models that may not generalize well to new data.

- In the first model, `pH_min:Lactate_max` is significant, suggesting an interactive effect of blood pH and lactate levels on the risk of in-hospital death.
- In the second model, `RespRate_max:Age` and `pH_min:Lactate_max` are significant, indicating that the effects of respiratory rate and blood pH on in-hospital death risk vary by age and lactate levels, respectively. 
- The third model reveals several more significant interactions, including `PaO2_max:Glucose_max`, `PaO2_max:Lactate_max`, `RespRate_max:Lactate_max`, and others, indicating multiple complex relationships that could be important for prediction.

**Noteworthy**: that the interaction terms `RespRate_max:Age` and `pH_min:Lactate_max` are significant across all models, which aligns with clinical insights. The significant interaction between maximum respiratory rate and age may indicate that the impact of respiratory rate on in-hospital mortality risk could vary by age, possibly because physiological responses to illness change with age. The significant and consistent interaction of blood pH and lactate levels (`pH_min:Lactate_max`) corroborates the medical understanding that elevated lactate levels, indicative of lactic acidosis, are a concerning sign of severe physiological stress or hypoxia, leading to worse patient outcomes. Simultaneously, a lower pH, indicating acidosis, has evident clinical relevance and is a critical factor in assessing the severity of a patient's condition.

**Inclusion of Main Effects**: Typically, when including an interaction term in a regression model, should also include the main effects of the interacting variables. This approach avoids the model misattributing the effects that should be captured by the main effects alone to the interaction term.

```{R task1.B_5 comparing models with / without interaction terms}
# Model with / without interaction terms
model_without_interactions <- intact_model
model_with_interactions <- update(intact_model, . ~ . + RespRate_max:Age + pH_min:Lactate_max)

# Compare models
anova(model_without_interactions, model_with_interactions, test = "Chisq")
```
The model with interaction terms has lower residual deviance compared to the model without interactions, suggesting that adding interaction terms explanatory power to the model.
The significant p-value (0.003402) for the comparison indicates that including the interaction terms between `RespRate_max:Age` and `pH_min:Lactate_max` does indeed improve the model. 

```{R task1.B_6 stepwise}
# Using stepwise regression to find an optimal set of predictors for intact model
stepwise_result <- stepAIC(intact_model, direction = "both", trace = FALSE)
summary(stepwise_result)
```
The task1.B_6 code uses stepwise regression with `stepAIC` to find an optimal set of predictors for the `intact_model`. 

**stepAIC** method adds or removes predictors based on the AIC value in a stepwise manner to identify a model that balances model complexity with information loss. StepAIC() helped refine the model by retaining significant predictors and removing those less contributive variables.
- The summary of the stepwise regression model presents similar significant variables and AIC as found in the previous model.
- `Urine_min`  shows a relatively high p-value (0.162323),implies that it may not contribute meaningful explanatory power to the model in predicting in-hospital death.

When removing the predictor, consider the following:
- **Clinical Judgment**: If the predictor is clinically important in understanding patient outcomes, it may be worth keeping it in the model for interpretational purposes.
- **Model Fit**: Check how the model fit changes without the predictor. Sometimes, non-significant variables can still improve the overall fit of the model.
- **Multicollinearity**: Ensure that removing the variable doesn't affect the multicollinearity of the model. Sometimes, non-significant variables can be acting as control variables for other significant predictors.

```{R task1.B_7 final model}
final_model <- glm(in_hospital_death ~ PaO2_max + RespRate_max + pH_min + Glucose_max + Lactate_max + Cholesterol_max + GCS_min + Creatinine_max + WBC_max + Age, 
                    family = binomial(link = "logit"), data = valid_data)
summary(final_model)

final_model2 <- glm(in_hospital_death ~ PaO2_max + RespRate_max + pH_min + Glucose_max + Lactate_max + Cholesterol_max + GCS_min + Creatinine_max  + RespRate_max:Age + pH_min:Lactate_max  + Age, 
                    family = binomial(link = "logit"), data = valid_data)
summary(final_model2)

final_model3 <- glm(in_hospital_death ~ PaO2_max + RespRate_max + pH_min + Glucose_max + Lactate_max + Cholesterol_max + GCS_min + Creatinine_max  + RespRate_max:Age + pH_min:Lactate_max  + Age + ICUType, 
                    family = binomial(link = "logit"), data = valid_data)
summary(final_model3)

final_model4 <- glm(in_hospital_death ~ GCS_min + Creatinine_max  + Age + ICUType, 
                    family = binomial(link = "logit"), data = valid_data)
summary(final_model4)

```

```{R task1.B_7B final model multicollinearity check by Variance Inflation Factor (VIF)}
vif_values_fm <- vif(final_model, type = 'terms')
vif_values_fm2 <- vif(final_model2, type = 'terms')
vif_values_fm3 <- vif(final_model3, type = 'terms')
vif_values_fm4 <- vif(final_model4, type = 'terms')

cat("VIF Results for Final Model:\n")
print(vif_values_fm)
cat("\n")

cat("VIF Results for Final Model 2:\n")
print(vif_values_fm2)
cat("\n")

cat("VIF Results for Final Model 3:\n")
print(vif_values_fm3)
cat("\n")

cat("VIF Results for Final Model 4:\n")
print(vif_values_fm4)
cat("\n")

```
_VIF values_
1. The VIF values common thresholds are 5 or 10, below that suggests that there isn't a concerning level of multicollinearity among the main effects in your model. 
1. High GVIF values for interaction terms are not uncommon, as these terms are products of their component variables and can inherit their collinearity.
2. High VIF/GVIF values do not imply that a model is invalid; rather, they suggest that the precision of the coefficient estimates for the related variables may be reduced.

```{R task1.B_8 final model relevant diagnostic statistics and/or charts}
# 1. Residuals Plot
plot(residuals(model_saps1, type = "deviance"), main = "Residuals Plot of SAPS1", ylab = "Deviance Residuals")
plot(residuals(model_sofa, type = "deviance"), main = "Residuals Plot of SOFA", ylab = "Deviance Residuals")
plot(residuals(final_model, type = "deviance"), main = "Residuals Plot of Final Model", ylab = "Deviance Residuals")
plot(residuals(final_model2, type = "deviance"), main = "Residuals Plot of Final Model 2", ylab = "Deviance Residuals")
plot(residuals(final_model3, type = "deviance"), main = "Residuals Plot of Final Model 3", ylab = "Deviance Residuals")
plot(residuals(final_model4, type = "deviance"), main = "Residuals Plot of Final Model 4", ylab = "Deviance Residuals")

# 2. Influence Plot (Cookâ€™s Distance)
influencePlot(model_saps1, main="Influence Plot of SAPS1", sub="Circle size is proportional to Cook's distance")
influencePlot(model_sofa, main="Influence Plot of SOFA", sub="Circle size is proportional to Cook's distance")
influencePlot(final_model, main="Influence Plot of Final Model", sub="Circle size is proportional to Cook's distance")
influencePlot(final_model2, main="Influence Plot of Final Model 2", sub="Circle size is proportional to Cook's distance")
influencePlot(final_model3, main="Influence Plot of Final Model 3", sub="Circle size is proportional to Cook's distance")
influencePlot(final_model4, main="Influence Plot of Final Model 4", sub="Circle size is proportional to Cook's distance")

# 3. ROC Curve
# Predicted probabilities for the models
pred_saps1 <- predict(model_saps1, type = "response")
pred_sofa <- predict(model_sofa, type = "response")
pred_fmodel <- predict(final_model, type = "response")
pred_fmodel2 <- predict(final_model2, type = "response")
pred_fmodel3 <- predict(final_model3, type = "response")
pred_fmodel4 <- predict(final_model4, type = "response")

# Create prediction objects for ROC analysis
pred_obj_saps1 <- prediction(pred_saps1, valid_data$in_hospital_death)
pred_obj_sofa <- prediction(pred_sofa, valid_data$in_hospital_death)
pred_obj_fmodel <- prediction(pred_fmodel, valid_data$in_hospital_death)
pred_obj_fmodel2 <- prediction(pred_fmodel2, valid_data$in_hospital_death)
pred_obj_fmodel3 <- prediction(pred_fmodel3, valid_data$in_hospital_death)
pred_obj_fmodel4 <- prediction(pred_fmodel4, valid_data$in_hospital_death)

# Create performance objects for ROC analysis
perf_saps1 <- performance(pred_obj_saps1, "tpr", "fpr")
perf_sofa <- performance(pred_obj_sofa, "tpr", "fpr")
perf_fmodel <- performance(pred_obj_fmodel, "tpr", "fpr")
perf_fmodel2 <- performance(pred_obj_fmodel2, "tpr", "fpr")
perf_fmodel3 <- performance(pred_obj_fmodel3, "tpr", "fpr")
perf_fmodel4 <- performance(pred_obj_fmodel4, "tpr", "fpr")

# Plot ROC curves
plot(perf_saps1, col = "red", main = "ROC Curves for SAPS1, SOFA Models and Final Models")
plot(perf_sofa, col = "blue", add = TRUE)
plot(perf_fmodel, col = "green", add = TRUE)
plot(perf_fmodel2, col = "purple", add = TRUE)
plot(perf_fmodel3, col = "orange", add = TRUE)
plot(perf_fmodel4, col = "plum", add = TRUE)
abline(a = 0, b = 1, lty = 2)

# Add a legend
legend("bottomright", legend = c("SAPS1 Model", "SOFA Model", "Final Model", "Final Model 2", "Final Model 3",  "Final Model 4"), 
       col = c("red", "blue", "green", "purple", "orange", "plum"), 
       lwd = 2)

# Calculate AUC for SAPS1 model
auc_saps1 <- performance(pred_obj_saps1, measure = "auc")
auc_saps1_value <- auc_saps1@y.values[[1]]
cat("AUC for SAPS1 Model:", auc_saps1_value, "\n")

# Calculate AUC for SOFA model
auc_sofa <- performance(pred_obj_sofa, measure = "auc")
auc_sofa_value <- auc_sofa@y.values[[1]]
cat("AUC for SOFA Model:", auc_sofa_value, "\n")

# Calculate AUC for Final models
auc_fmodel <- performance(pred_obj_fmodel, measure = "auc")
auc_fmodel_value <- auc_fmodel@y.values[[1]]
cat("AUC for Final Model:", auc_fmodel_value, "\n")
auc_fmodel2 <- performance(pred_obj_fmodel2, measure = "auc")
auc_fmodel2_value <- auc_fmodel2@y.values[[1]]
cat("AUC for Final Model2:", auc_fmodel2_value, "\n")
auc_fmodel3 <- performance(pred_obj_fmodel3, measure = "auc")
auc_fmodel3_value <- auc_fmodel3@y.values[[1]]
cat("AUC for Final Model3:", auc_fmodel3_value, "\n")
auc_fmodel4 <- performance(pred_obj_fmodel4, measure = "auc")
auc_fmodel4_value <- auc_fmodel4@y.values[[1]]
cat("AUC for Final Model4:", auc_fmodel4_value, "\n")
```
_residual plots_
For all models, plots are a similar that shows a random scatter of residuals around the zero line without any clear pattern. This suggests non-linearity or other issues with the models fit.

_influence plots_
In the influence plots provided for each model, we see the standardized residuals plotted against the leverage (hat values) of each observation, with the size of the circles proportional to Cook's Distance. 
1. **SAPS1 Model Influence Plot**:
   - There are a few observations with high leverage, particularly one that stands out with a very high Cook's Distance. This suggests that this observation has a significant influence on the model.
   - The plot indicates that while most data points have low leverage and limited influence on the model, the ones with high Cook's Distance might be potential outliers or influential points that warrant further investigation.

2. **SOFA Model Influence Plot**:
   - Similar to the SAPS1 model, there are points with notably higher leverage, and one observation, in particular, has a high Cook's Distance, suggesting it has a strong influence on the model's predictions.
   - Most observations cluster around low leverage, which suggests that they are not unduly influencing the model.

3. **Final Models Influence Plots**:
   - The plot shows a higher density of points with moderate to high leverage compared to the previous two models. This could be due to the increased complexity of the model with more predictors.
   - Several observations have a significantly large Cook's Distance, which indicates that they are influential to the regression results. These points should be examined to determine if they represent true relationships or if they are outliers that could be skewing the model.

_AUC_
An AUC close to 1 indicates a very good model, while an AUC closer to 0.5 suggests a less useful model.
Final Model 3 has the highest AUC, shows the best ability to discriminate between patients who will have in-hospital death and those who will not. However, before adopting it for practical use, should consider the clinical utility and potential for overfitting carefully.
   
```{R task1.B_9 influential_point check}
influential_point <- icu_patients_df1_h[1175, c("Age", "PaO2_max", "RespRate_max", "pH_min", "Glucose_max", "Lactate_max", "Cholesterol_max", "GCS_min", "Creatinine_max", "in_hospital_death")]
print(influential_point)
model_point_demo <- summary(icu_patients_df1[c("Age", "PaO2_max", "RespRate_max", "pH_min", "Glucose_max", "Lactate_max", "Cholesterol_max", "GCS_min", "Creatinine_max")])
kable(model_point_demo, caption = "model Demographics Summary", format = "markdown")
```
After check this influential_point, we find that:
- **Creatinine_max:** A maximum creatinine level of 22 is significantly higher than the maximum in the summary statistics.
- **GCS_min:** The minimum Glasgow Coma Scale (GCS) score of 3 is the lowest possible score, indicating severe brain injury or deep unconsciousness.
- **In-hospital death (0):** Despite severe kidney dysfunction, deep unconsciousness, and possible respiratory distress, the patient survived the hospital stay.This is kind of counterintuitive by consider the clinical parameters.
It's might be essential to review the medical records for such patients to understand the context better, validate the data accuracy, and decide on the inclusion in the analysis.

```{R task1.B_10 re-fit the 'final_model3'  to the unimputed data frame}
final_model3_demo <- summary(icu_patients_df0[c("Age", "PaO2_max", "RespRate_max", "pH_min", "Glucose_max", "Lactate_max", "Cholesterol_max", "GCS_min", "Creatinine_max", "SAPS1", "SOFA")])
kable(final_model3_demo, caption = "Final Model 3 Demographics Summary", format = "markdown")

# Trans 'Gender' and 'ICUType' as factors
icu_patients_df0$Gender <- as.factor(icu_patients_df0$Gender)
icu_patients_df0$ICUType <- as.factor(icu_patients_df0$ICUType)

# Refit the model using this imputed dataset
final_model3_unimputed <- glm(in_hospital_death ~ PaO2_max + RespRate_max + pH_min + Glucose_max + Lactate_max + Cholesterol_max + GCS_min + Creatinine_max + RespRate_max:Age + pH_min:Lactate_max + Age + ICUType, 
                              family = binomial(link = "logit"), 
                              data = icu_patients_df0)

summary(final_model3_unimputed)
```
```{R task1.B_11 identify the variables with more than 50% missing data in icu_patients_df0}
# Set a threshold for maximum acceptable proportion of missing data
missing_threshold <- 0.5

# Specify the variables used in 'final_model3'
variables_final_model3 <- c("Age", "PaO2_max", "RespRate_max", "pH_min", "Glucose_max",
                            "Lactate_max", "Cholesterol_max", "GCS_min", "Creatinine_max", "ICUType")

# Calculate the proportion of missing data for each variable used in 'final_model3'
prop_missing_final_model3 <- sapply(icu_patients_df0[variables_final_model3], function(x) sum(is.na(x)) / length(x))

# Identify variables used in 'final_model3' with more than the threshold of missing data
vars_to_exclude_final_model3 <- names(prop_missing_final_model3[prop_missing_final_model3 > missing_threshold])

# Print the variables with more than 50% missing data from 'final_model3'
print(vars_to_exclude_final_model3)


```

_missing data_
When attempting to refit the 'final_model3' to the unimputed data frame "icu_patients_df0", a significant problem was encountered due to missing data. 
- The presence of NA values in the model summary for most coefficients suggests that the glm function could not estimate the model parameters.
- With predictor variables like `RespRate_max` missing over 1506 values, `Cholesterol_max` missing 1930, and `Lactate_max` missing 1071, as well as `PaO2_max`	missing 603, there's a substantial loss of information. 
- Several predictor variables had more than 50% of their values missing, making it impractical to include them in the model without some form of imputation.
- For those variables have more than 50% missing data, might consider dropping it from the model entirely, especially if it is not a key predictor or if there is no easy way to impute its values accurately.
**Thus, go back to task1.b_7, create and test `final_model4` as an alternative solution.**

```{R task1.B_12 re-fit the 'final_model4' to the unimputed data frame}
# Refit the model using 'final_model4'
final_model4 <- glm(in_hospital_death ~ GCS_min + Creatinine_max + Age + ICUType, 
                              family = binomial(link = "logit"), 
                              data = icu_patients_df0)

summary(final_model4)
```

```{R task1.B_13 final model relevant diagnostic statistics and/or charts}
# Using dplyr to filter out cases where the specified variables are NA
valid_data0 <- icu_patients_df0 %>% filter(!is.na(SAPS1) & !is.na(GCS_min) & !is.na(Creatinine_max))


# Logistic regression to see the effect of SAPS1 and SOFA scores on in-hospital death
model0_saps1 <- glm(in_hospital_death ~ SAPS1, data = valid_data0, family = binomial)
model0_sofa <- glm(in_hospital_death ~ SOFA, data = valid_data0, family = binomial)
model0_fmodel4 <- glm(in_hospital_death ~ GCS_min + Creatinine_max + Age + ICUType, data = valid_data0, family = binomial(link = "logit"))

# Predicted probabilities for the models
pred0_saps1 <- predict(model0_saps1, type = "response")
pred0_sofa <- predict(model0_sofa, type = "response")
pred0_fmodel4 <- predict(model0_fmodel4, type = "response")

# Create prediction objects for ROC analysis
pred0_obj_saps1 <- prediction(pred0_saps1, valid_data0$in_hospital_death)
pred0_obj_sofa <- prediction(pred0_sofa, valid_data0$in_hospital_death)
pred0_obj_fmodel4 <- prediction(pred0_fmodel4, valid_data0$in_hospital_death)

# Create performance objects for ROC analysis
perf0_saps1 <- performance(pred0_obj_saps1, "tpr", "fpr")
perf0_sofa <- performance(pred0_obj_sofa, "tpr", "fpr")
perf0_fmodel4 <- performance(pred0_obj_fmodel4, "tpr", "fpr")

# Plot ROC curves
plot(perf0_saps1, col = "plum", main = "ROC Curves for SAPS1, SOFA and Final Model on icu_patients_df0")
plot(perf0_sofa, col = "skyblue", add = TRUE)
plot(perf0_fmodel4, col = "moccasin", add = TRUE)
abline(a = 0, b = 1, lty = 2)

# Add a legend
legend("bottomright", legend = c("SAPS1 Model", "SOFA Model", "Final Model 4"), col = c("plum", "skyblue", "moccasin"), lwd = 2)

# Calculate AUC for SAPS1 model
auc0_saps1 <- performance(pred0_obj_saps1, measure = "auc")
auc0_saps1_value <- auc0_saps1@y.values[[1]]
cat("AUC for SAPS1 Model:", auc0_saps1_value, "\n")

# Calculate AUC for SOFA model
auc0_sofa <- performance(pred0_obj_sofa, measure = "auc")
auc0_sofa_value <- auc0_sofa@y.values[[1]]
cat("AUC for SOFA Model:", auc0_sofa_value, "\n")


# Calculate AUC for Final model
auc0_fmodel4 <- performance(pred0_obj_fmodel4, measure = "auc")
auc0_fmodel4_value <- auc0_fmodel4@y.values[[1]]
cat("AUC for Final Model4:", auc0_fmodel4_value, "\n")

```

Regarding missing data and model complexity, selecting `final_model4` with simplified set of predictors consisting of `GCS_min`, `Creatinine_max`, `Age`, and `ICUType`, to refit to the unimputed dataset `icu_patients_df0`.
- The summary of the refitted model on `icu_patients_df0` indicates that all the predictors are significant.
- Compare the AIC values in {task1.B_0} and {task1.B_7}, the AIC values of `final_model4` suggesting it is fit good enough on both data sets (`icu_patients_df0` and `icu_patients_df1`).
- With the unimputed data (`icu_patients_df0`), Final Model 4 maintained its performance, suggesting robustness across different datasets.
- The AUC values obtained from ROC analysis suggest that the performance of Final Model 4 is better than the SAPS1 and SOFA models on the unimputed data.

# Task 2

### Part A: Exploratory Data Analysis

The goal of this EDA is similar to Task 1 and you may choose to use the same sub-set of predictors if they are relevant and appropriate to the analysis for Task 2. You may also choose to select a different sub-set if you wish. Justify whichever approach you choose.

Present enough information to: (i) explain why you selected these variables, and (ii) Provide an overview of the variables and how they are related to survival. Present your summary using tables and/or plots with supporting commentary where relevant.


### Part B: Explanatory survival model

Your aim is to try to understand and EXPLAIN how survival time varies by `Age`. How does survival change with increasing Age?  Can any age-related differences in survival time be explained by differing clinical presentations of older patients?

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately **explains** the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a univariable model examining the relationship between Age and survival. You should then also fit another one or two multivariable models, to examine the extent that survival is explained by other variables in the dataset and whether age is independently related to survival after controlling for other factors.  Your final model should **not** include all the predictor variables, just a relevant subset of them, which you have selected based on statistical significance and/or background knowledge.  It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at least comment on the possible impact of what your diagnostics show). 

Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.

**Create your response to task 2 here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text. Add code chunks as you see fit and choose whether you wish for the code and or results to be displayed in the final html document.** 

```{r}


```




### Hints

1. Make sure you justify your choice of potential predictors. This could be based on a range of different factors, eg. review of the literature, data quality assessment, strong association with the outcome. 

2. Present the story of your analysis by including explanation and commentary supported by well-presented plots and/or tables. 

3. Make sure all plots and tables are clearly presented with titles and labels as needed. Pay attention to sizing of plots and make sure you check how the rendered result appears. 

4. Clearly define your starting population for the analysis and describe the characteristics of your outcome variable. 

5. Present summaries of appropriate univariate models examining the unadjusted relationship between each predictor and the outcome. 

6. Fit an appropriate series of multivariable regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

7. Present your final model for each task and justify why this model is the most appropriate to answer the analytical question(s). Your final model(s) should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance, background knowledge and relevance to achieving the analytical aim.

8. For your _final model_, present a set of diagnostic statistics and/or charts and comment on them.

9. For each task make sure you write a paragraph or two summarising the most important findings of your analysis. Include reference to the most important results from the statistical output, and a simple clinical interpretation. Make sure your summary of findings addresses the main analytical aim(s) for each task. 




## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works and appears in the right format, and then submit TWO documents via the drop box in OpenLearning (.rmd AND .html).


### Problems?

If you encounter problems with any part of the process described above, please contact the course convenor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assessment is due.


### Additional Information

The instructions are deliberately less prescriptive than the individual assessments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks, you only need to replicate or repeat the steps covered in the course - you do not need to attempt any types of analyses that have not been covered. Refer to the marking rubric for how marks will be awarded.   

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course convenor.   
