---
title: "HDAT9600 Final Team Assignment"
subtitle: "Please see course timetable / 'Announcements' for submission deadline"
author: "Team 3: Zhenyu"
date: "insert date of completion here"
output: html_document
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)

## required packages for examples 
libs <- c("eha", "stringi", "bshazard", "survminer")
missing <- !libs %in% installed.packages()
if (any(missing)) {
  install.packages(libs[missing],repos="https://cloud.r-project.org")
}

library(eha)
library(stringi)
library(bshazard)
library(survminer)
library(ggplot2)
library(pch)
library(survival)
library(flexsurv)
library(muhaz)
library(eha)
library(MASS)
library(ROCR)
library(tidyr)
library(dplyr)
library(ggplot2)
library(caret)
library(DescTools)
library(pROC)
library(knitr)
```

## Instructions

* This file (hdat9600assess4_teamX.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final team assignment.
* You should rename the file by replacing 'X' with your team number.
* This assignment is assessed and will count for 30% of the total course marks.
* The assignment comprises two tasks. The first task will focus on building a model to PREDICT an outcome and the second task will focus on using a model to EXPLAIN the relationships between a variable of interest and the outcome.
* There is no word limit, nor limit on the length of your submitted Rmarkdown (i.e. this file) document. However, the **rendered** html document, were it to be printed, should be **no more** than about 10 A4 pages in length. 
* Your html rendered document should include sufficient code chunks, output, and visual display as necessary to support your discursive commentary addressing each task. You may therefore wish to **suppress some of the contents** of your Rmarkdown file from appearing within the rendered document to ensure your output focuses on the most relevant results and discussion to address the questions.
* The rendered (html) document will be the submission primarily considered when awarding credit. However, the Rmarkdown file may also be considered if required to understand the analysis.
* <strong> Excessively long reports will be penalised </strong> by cessation of awarding of credit after roughly 10 pages of content.
* Feel free to delete the assignment instructions as you see fit to allow you some more room. 
* All tasks are intended to be completed as a team. Have fun discussing the tasks and working together.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor is happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assessment for you!


## Data for this assessment

The data used for this assessment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assessment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. The original data has been modified and assembled to suit the purpose of this assessment. 

The dataframe consists of 120 variables, which are defined as follows:

#### Patient Descriptor Variables
<li> <em>RecordID:</em>            a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patientâ€™s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


#### Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


#### Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

* SAPS-I score - Simplified Acute Physiological Score [Le Gall et al., 1984](http://www.ncbi.nlm.nih.gov/pubmed/6499483)
* SOFA score - Sequential Organ Failure Assessment [Ferreira et al., 2001](http://www.ncbi.nlm.nih.gov/pubmed/11594901)

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

* [Albumin](http://en.wikipedia.org/wiki/Human_serum_albumin)
 (g/dL)
* [ALP](http://en.wikipedia.org/wiki/Alkaline_phosphatase)
 [Alkaline phosphatase (IU/L)]
* [ALT](http://en.wikipedia.org/wiki/Alanine_transaminase)
 [Alanine transaminase (IU/L)]
* [AST](http://en.wikipedia.org/wiki/Aspartate_transaminase)
 [Aspartate transaminase (IU/L)]
* [Bilirubin](http://en.wikipedia.org/wiki/Bilirubin)
 (mg/dL)
* [BUN](http://en.wikipedia.org/wiki/BUN)
 [Blood urea nitrogen (mg/dL)]
* [Cholesterol](http://en.wikipedia.org/wiki/Cholesterol)
 (mg/dL)
* [Creatinine](http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine)
 [Serum creatinine (mg/dL)]
* [DiasABP](http://en.wikipedia.org/wiki/Diastolic_blood_pressure)
 [Invasive diastolic arterial blood pressure (mmHg)]
* [FiO2](http://en.wikipedia.org/wiki/FIO2)
 [Fractional inspired O<sub>2</sub> (0-1)]
* [GCS](http://en.wikipedia.org/wiki/Glasgow_coma_score)
 [Glasgow Coma Score (3-15)]
* [Glucose](http://en.wikipedia.org/wiki/Serum_glucose)
 [Serum glucose (mg/dL)]
* [HCO3](http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics)
 [Serum bicarbonate (mmol/L)]
* [HCT](http://en.wikipedia.org/wiki/Hematocrit)
 [Hematocrit (%)]
* [HR](http://en.wikipedia.org/wiki/Heart_rate)
 [Heart rate (bpm)]
* [K](http://en.wikipedia.org/wiki/Hypokalemia)
 [Serum potassium (mEq/L)]
* [Lactate](http://en.wikipedia.org/wiki/Lactic_acid)
 (mmol/L)
* [Mg](http://en.wikipedia.org/wiki/Magnesium#Biological_role)
 [Serum magnesium (mmol/L)]
* [MAP](http://en.wikipedia.org/wiki/Mean_arterial_pressure)
 [Invasive mean arterial blood pressure (mmHg)]
* [MechVent](http://en.wikipedia.org/wiki/Mechanical_ventilation)
 [Mechanical ventilation respiration (0:false, or 1:true)]
* [Na](http://en.wikipedia.org/wiki/Serum_sodium)
 [Serum sodium (mEq/L)]
* [NIDiasABP](http://en.wikipedia.org/wiki/Diastolic_blood_pressure)
 [Non-invasive diastolic arterial blood pressure (mmHg)]
* [NIMAP](http://en.wikipedia.org/wiki/Mean_arterial_pressure)
 [Non-invasive mean arterial blood pressure (mmHg)]
* [NISysABP](http://en.wikipedia.org/wiki/Systolic_blood_pressure)
 [Non-invasive systolic arterial blood pressure (mmHg)]
* [PaCO2](http://en.wikipedia.org/wiki/Arterial_blood_gas)
 [partial pressure of arterial CO<sub>2</sub> (mmHg)]
* [PaO2](http://en.wikipedia.org/wiki/Arterial_blood_gas)
 [Partial pressure of arterial O<sub>2</sub> (mmHg)]
* [pH](http://en.wikipedia.org/wiki/Arterial_blood_gas)
 [Arterial pH (0-14)]
* [Platelets](http://en.wikipedia.org/wiki/Platelets)
 (cells/nL)
* [RespRate](http://en.wikipedia.org/wiki/Respiratory_physiology)
 [Respiration rate (bpm)]
* [SaO2](http://en.wikipedia.org/wiki/Arterial_blood_gas)
 [O<sub>2</sub> saturation in hemoglobin (%)]
* [SysABP](http://en.wikipedia.org/wiki/Systolic_blood_pressure)
 [Invasive systolic arterial blood pressure (mmHg)]
* [Temp](http://en.wikipedia.org/wiki/Normal_human_body_temperature)
 [Temperature (&deg;C)]
* [TropI](http://en.wikipedia.org/wiki/Troponin)
 [Troponin-I (&mu;g/L)]
* [TropT](http://en.wikipedia.org/wiki/Troponin)
 [Troponin-T (&mu;g/L)]
* [Urine](http://en.wikipedia.org/wiki/Fluid_balance)
 [Urine output (mL)]
* [WBC](http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology)
 [White blood cell count (cells/nL)]
* Weight (kg)


## Accessing the Data
There are two datasets provided. The data frames can be loaded with the following code:

```{r task0 read and check}
mydat <- file.path("C:/Users/froze/OneDrive/Documents/2.1 UNSW bioinfo/HDAT9600/Assignment/Group/HDAT9600_Assign4_GroupProject")

icu_patients_df0 <- readRDS(file.path(mydat,"icu_patients_df0.rds"))
icu_patients_df1 <- readRDS(file.path(mydat,"icu_patients_df1.rds"))
#summary(icu_patients_df1) #check  data frame structure
#str(icu_patients_df1)
#glimpse(icu_patients_df1) #quickly see the entirety of the data frame's structure and less likely to truncate

# Calculate the number of missing values for each column
missing_values <- colSums(is.na(icu_patients_df1))
# Remove the variables that do not have missing values
missing_values <- missing_values[missing_values > 0]
# Print the variables with their count of missing values
print(missing_values)
```

**Note:** icu_patients_df1 is an imputed (i.e. missing values are 'derived') version of icu_patients_df0.  This assessment does not concern the methods used for imputation. You should use `icu_patients_df1` for all tasks unless it is specifically noted to use `icu_patients_df0`. 

From the output and combined with reference papers, here are some variables that correspond to the SAPS-I and SOFA scores and could be considered important for the models:
1. **SAPS-I score**: The dataset includes SAPS1 as a variable, which is directly relevant.
2. **SOFA score**: The dataset includes SOFA as a variable, also directly relevant.
3. **Respiratory function**: PaO2/FiO2 ratio (part of SOFA), and Respiratory rate (part of SAPS-I). In the dataset, PaO2, FiO2 and RespRate variables could be related to respiratory function (not find MechVent variable).
4. **Coagulation**: Platelets count is directly mentioned in the dataset and SOFA.
5. **Liver function**: Bilirubin levels are included in both the dataset and the SOFA score.
6. **Cardiovascular system**: The presence of hypotension and administration of dopamine or dobutamine are factors in the SOFA score. In the dataset, variables like MAP, SysABP, and NIMAP are related to blood pressure and might be used as proxies.
7. **Central nervous system**: Glasgow Coma Score is present in both the SOFA and SAPS-I scores and directly available in the dataset (GCS variables).
8. **Renal function**: Creatinine levels and Urine output, which are in SOFA and indirectly in SAPS-I (blood urea), correspond to Creatinine and Urine variables in the data.
9. **Age**: This is explicitly mentioned in SAPS-I and is a known risk factor in ICU outcomes. The Age variable is available in the dataset.

Considering these variables for inclusion in the predictive models for Task 1 (Logistic Regression for in-hospital death) and Task 2 (Survival Analysis for length of survival) would be reasonable based on their clinical importance and representation in established severity scores.

**Variables with Missing Data:**
- `SAPS1`: 96 missing values (4.66% missing) - This is a relatively small proportion of the dataset. Since SAPS-I is an important score for ICU prognosis, it might be worth imputing these values rather than excluding the variable.
- `Survival`: 1,288 missing values (62.48% missing) - This is a significant amount of missing data. However, 'Survival' may represent censored data rather than simply missing information. In survival analysis, this would be the expected setup, where patients who did not die in the hospital are censored at the last follow-up time.
- Blood pressure-related variables (`DiasABP_diff`, `DiasABP_max`, `DiasABP_min`, `NIDiasABP_diff`, `NIDiasABP_max`, `NIDiasABP_min`, `NIMAP_diff`, `NIMAP_max`, `NIMAP_min`, `NISysABP_diff`, `NISysABP_max`, `NISysABP_min`, `SysABP_diff`, `SysABP_max`, `SysABP_min`): All these have a high degree of missingness, ranging from 21.98% to 34.54%. Since these are many related variables with substantial missing data, we might consider/test the importance of blood pressure measurement in your analysis and whether it could be captured by fewer variables (maybe only MAP).
- `Height`: 992 missing values (48.10% missing) - If height is not central to analysis and considering the high rate of missingness, it could be a candidate for exclusion.
- Weight-related variables (`Weight_diff`, `Weight_max`, `Weight_min`): 146 missing values (7.08% missing) - This is a smaller proportion of missing data and might be worth imputing if weight is considered important in analysis.


```{r task0_data clean (optional)}
# Set a threshold for maximum acceptable proportion of missing data
missing_threshold <- 0.5
# Calculate the proportion of missing data for each variable
prop_missing <- colSums(is.na(icu_patients_df1)) / nrow(icu_patients_df1)
# Identify variables to exclude based on the threshold
vars_to_exclude <- names(prop_missing[prop_missing > missing_threshold])
# Identify variables to impute
vars_to_impute <- names(prop_missing[prop_missing <= missing_threshold & prop_missing > 0])
# Make a copy of the data frame to clean
icu_patients_df1_cleaned <- icu_patients_df1
# Impute missing values for selected variables using median
for(var in vars_to_impute) {
  icu_patients_df1_cleaned[[var]][is.na(icu_patients_df1_cleaned[[var]])] <- median(icu_patients_df1_cleaned[[var]], na.rm = TRUE)
}
# Now exclude the variables with too much missing data from the cleaned dataframe
icu_patients_df1_cleaned <- icu_patients_df1_cleaned[ , !(names(icu_patients_df1_cleaned) %in% vars_to_exclude)]

# Check if there is any missing vcalues
missing_values2 <- colSums(is.na(icu_patients_df1_cleaned))
missing_values2 <- missing_values2[missing_values2 > 0]
print(missing_values2)
```
## Aims of your project

You have two analytic goals in this assignment. 
1. The first goal (Task 1) is to build a model to PREDICT in-hospital death. The context for this is that the hospital management wishes to use this model to prioritise the allocation of resources with the overarching aim of improving patient survival.  
2. The second goal (Task 2) is to try to understand and EXPLAIN how survival varies by `Age`. How does survival change with increasing Age? Are age-related survival differences explained solely by differing clinical characteristics of patients? 


# Task 1

### Part A: Exploratory data analysis

Conduct a brief EDA for the dataset `icu_patients_df1`. One of your goals for this EDA should be to identify a sub-set of variables (approx 15-20 variables) that _may_ be useful predictors of survival and/or relevant to your analytical task. You may wish to firstly undertake a brief literature review to try to identify factors that may be important predictors of survival in an ICU. This doesn't need to be in-depth, but enough to get a basic idea of what the variables are measuring and which variables might, in theory, be most important. 

For the 15-20 chosen variables, present enough information to: (i) explain why you selected these variables, based on a combination of your literature review and EDA, and (ii) Provide an overview of the variables and how they are related to `in-hospital death`. Present your summary using tables and/or plots with supporting commentary where relevant. 

```{r task1.A_1 Demographics summary}
# Overall Demographics Summary
overall_demo <- summary(icu_patients_df1[c("Age", "Height", "Weight_max", "Weight_min", "SOFA", "SAPS1")])
kable(overall_demo, caption = "Overall Demographics Summary", format = "markdown")

# Split the dataset into survivors and non-survivors
survivors_df <- icu_patients_df1[icu_patients_df1$in_hospital_death == 0, ]
deceased_df <- icu_patients_df1[icu_patients_df1$in_hospital_death == 1, ]

# Summary for Survivors
survivors_demo <- summary(survivors_df[c("Age", "Weight_max", "Weight_min", "Length_of_stay", "SOFA", "SAPS1")])
kable(survivors_demo, caption = "Demographics Summary for Survivors", format = "markdown")

# Summary for Non-Survivors
deceased_demo <- summary(deceased_df[c("Age", "Weight_max", "Weight_min", "Length_of_stay", "Survival", "SOFA", "SAPS1")])
kable(deceased_demo, caption = "Demographics Summary for Non-Survivors", format = "markdown")


# Create a table for Gender Distribution, Number of in hospital Deaths, and ICU Types
# Calculate the required numbers and percentages
patients_count <- nrow(icu_patients_df1)
gender_counts <- table(icu_patients_df1$Gender)
gender_percentages <- prop.table(gender_counts) * 100
death_counts <- sum(icu_patients_df1$in_hospital_death, na.rm = TRUE)
death_percentage <- (death_counts / patients_count) * 100
icu_type_counts <- table(icu_patients_df1$ICUType)
icu_type_percentages <- prop.table(icu_type_counts) * 100

# Create a data frame with the calculated values
demographics_table <- data.frame(
  Category = c("Number_of_Patients",
               "Gender: Male",
               "Gender: Female",
               "in_hospital_death",
               "ICU Types: Coronary Care Unit",
               "ICU Types: Cardiac Surgery Recovery Unit",
               "ICU Types: Medical ICU",
               "ICU Types: Surgical ICU"),
  Number = c(patients_count,
             gender_counts["Male"],
             gender_counts["Female"],
             death_counts,
             icu_type_counts["Coronary Care Unit"],
             icu_type_counts["Cardiac Surgery Recovery Unit"],
             icu_type_counts["Medical ICU"],
             icu_type_counts["Surgical ICU"]),
  Percentage = c(NA,  # Placeholder for total patients percentage
                 gender_percentages["Male"],
                 gender_percentages["Female"],
                 death_percentage,
                 icu_type_percentages["Coronary Care Unit"],
                 icu_type_percentages["Cardiac Surgery Recovery Unit"],
                 icu_type_percentages["Medical ICU"],
                 icu_type_percentages["Surgical ICU"])
)

# Use kable to print the table
kable(demographics_table, caption = "Demographics Summary 2", align = c('l', 'r', 'r'), format = "markdown")

```
**Overall Demographics Summary:**
- Patients range in age from 16 to 90, with a median age of 67, suggesting a predominantly older patient population.
- Height varies widely, with some extreme values (min 13 cm, max 426.7 cm), indicating possible data entry errors, given the maximum height is biologically implausible.
- The max weight of patients (Weight_max) and minimum weight (Weight_min) during the stay are similar in range, indicating relatively stable weight during ICU stay or uniformity in recording practices.
- SOFA scores, which range from -1 to 22, with a mean of 6.441, indicate varying degrees of organ failure severity among patients.
- SAPS1 scores also show a wide range, but there are missing values for SAPS1 that may need addressing for complete analysis.

**Demographics Summary for Survivors and Non-Survivors:**
- Survivors have a slightly lower mean age (63.29) compared to the overall (64.41) and non-survivor (71.05) groups, and the length of stay varies from -1 (which could be an error) to 154 days.
- A small number of survivors have maximum and minimum weights at the upper limit of 230 kg, which may be outliers or may represent a small subset of critically ill patients with a higher body weight.
- The median and mean weights for non-survivors are slightly lower than for survivors, which could reflect severe illness trajectories that may affects body weight. However, in general, the distribution of weight data does not indicate dramatic differences between survivors and non-survivors.
- The median and average SOFA and SAPS1 scores among survivors is lower than non-survivors, which aligns with the understanding that higher scores are associated with more severe organ dysfunction and a higher likelihood of mortality.

**Demographics Table Summary 2:**
- There were 2061 patients in total, with a higher proportion of males (approximately 55.70%) compared to females.
- The proportion of patients who died in the hospital was about 14.41%.
- The distribution of patients across ICU types shows the largest number in the Medical ICU (38.23%) and the least in the Coronary Care Unit (14.41%).


```{r task1.A_2 Plotting distributions of a variable}
# Add a descriptive label for in-hospital death status
icu_patients_df1$Status_Label <- ifelse(icu_patients_df1$in_hospital_death == 0, "Survived", "Died")
icu_patients_df1$Status_Label <- as.factor(icu_patients_df1$Status_Label)

# Create a list of demographic variables to plot
demographic_vars <- c("Age", "Height", "Weight_max", "Weight_min", "Length_of_stay", "Survival")

# Create a series of plots for each demographic variable
plots <- lapply(demographic_vars, function(var) {
  ggplot(icu_patients_df1, aes_string(x = var, fill = "Status_Label")) +
    geom_histogram(position = "dodge", binwidth = 5, na.rm = TRUE) +
    labs(x = var, y = "Count") +
    scale_fill_brewer(palette = "Set1", name = "Outcome") +
    theme_minimal() +
    ggtitle(paste("Distribution of", var, "by In-Hospital Death Status"))
})

# Print the plots
print(plots[[1]]) # For Age
print(plots[[2]]) # For Height
print(plots[[3]]) # For Weight_max
print(plots[[4]]) # For Weight_min
print(plots[[5]]) # For Length_of_stay
print(plots[[6]]) # For Survival


```
For the `Height` which < 17.8 or > 365 should be error on data collection or recording

```{r task1.A_3 Correct the 'Height' variable}
# Correct the 'Height' variable by setting values outside the range 50 to 250 to NA
icu_patients_df1_h <- icu_patients_df1
icu_patients_df1_h$Height <- ifelse(icu_patients_df1_h$Height < 50 | icu_patients_df1_h$Height > 250, NA, icu_patients_df1_h$Height)

# Recheck the summary for Height in the new dataframe and reprint the plot
summary(icu_patients_df1_h$Height)

plots2 <- lapply(demographic_vars, function(var) {
  ggplot(icu_patients_df1_h, aes_string(x = var, fill = "Status_Label")) +
    geom_histogram(position = "dodge", binwidth = 5, na.rm = TRUE) +
    labs(x = var, y = "Count") +
    scale_fill_brewer(palette = "Set1", name = "Outcome") +
    theme_minimal() +
    ggtitle(paste("Distribution of", var, "by In-Hospital Death Status"))
})

print(plots2[[2]])
```
**Histograms of the distribution of patient demographics**
- Age Distribution: There is a noticeable increase in the count of younger patients who survived compared to those who did not, with survival rates decreasing as age increases. Particularly, the survival rate is significantly lower for patients aged above 70.
- Height Distribution: The distribution of height shows a fairly normal range with most individuals between 150 and 200 cm. A few outliers below 150 cm may require verification for accuracy. The survival seems independent of height as both survived and died groups are similarly distributed.
- Maximum &  Minimum Weight Distribution: The weight of patients is concentrated around 50 to 100 kg. This indicates that extreme weights are not common among patients. The survival seems not too much dependent of the patientâ€™s weight.
- Length of Stay: The majority of patients had a shorter length of stay in the ICU. The survival seems independent of the number of days between the patientâ€™s admission to the ICU and the end of hospitalisation as both survived and died groups are similarly distributed.
- Survival Days: The survival days histogram is heavily skewed, with most patients surviving fewer days. The high number of patients with 0 survival days may indicate a significant number of deaths occurring shortly after admission to the ICU.

### Part B: Predictive logistic model

Your aim is to build a model to PREDICT in-hospital death. In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately **predicts** the `in_hospital_death` variable as the outcome and utilises predictor variables from your chosen subset. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small selection of them, which you have selected based on statistical significance and/or background knowledge. Remember, your aim is prediction, but you should also consider generalisability of the model, so we are aiming for parsimony. Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of relevant diagnostic statistics and/or charts and comment on them. 

Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


**Create your response to task 1 here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text. Add code chunks as you see fit and choose whether you wish for the code and or results to be displayed in the final html document.** 

```{R task1.B_0 check SAPS1 and SOFA as reference}
# Exclude observations where SAPS1 is NA as SAPS1 has 96 missing values
valid_data <- icu_patients_df1[!is.na(icu_patients_df1$SAPS1), ]

# Logistic regression to see the effect of SAPS1 and SOFA scores on in-hospital death
model_saps1 <- glm(in_hospital_death ~ SAPS1, data = valid_data, family = binomial)
model_sofa <- glm(in_hospital_death ~ SOFA, data = valid_data, family = binomial)

# Summary of logistic regression models
summary(model_saps1)
summary(model_sofa)

# Predicted probabilities for the models
pred_saps1 <- predict(model_saps1, type = "response")
pred_sofa <- predict(model_sofa, type = "response")

# Create prediction objects for ROC analysis
pred_obj_saps1 <- prediction(pred_saps1, valid_data$in_hospital_death)
pred_obj_sofa <- prediction(pred_sofa, valid_data$in_hospital_death)

# Create performance objects for ROC analysis
perf_saps1 <- performance(pred_obj_saps1, "tpr", "fpr")
perf_sofa <- performance(pred_obj_sofa, "tpr", "fpr")

# Plot ROC curves
plot(perf_saps1, col = "red", main = "ROC Curves for SAPS1 and SOFA Models")
plot(perf_sofa, col = "blue", add = TRUE)
abline(a = 0, b = 1, lty = 2)

# Add a legend
legend("bottomright", legend = c("SAPS1 Model", "SOFA Model"), col = c("red", "blue"), lwd = 2)

# Calculate AUC for SAPS1 model
auc_saps1 <- performance(pred_obj_saps1, measure = "auc")
auc_saps1_value <- auc_saps1@y.values[[1]]
cat("AUC for SAPS1 Model:", auc_saps1_value, "\n")

# Calculate AUC for SOFA model
auc_sofa <- performance(pred_obj_sofa, measure = "auc")
auc_sofa_value <- auc_sofa@y.values[[1]]
cat("AUC for SOFA Model:", auc_sofa_value, "\n")

```
These models provide a baseline for what can be expected when using SAPS1 and SOFA scores to predict in-hospital mortality
For the **SAPS1 model**:
- The coefficient for SAPS1 is 0.12558 with a p-value < 2e-16, indicating a statistically significant association with in-hospital death. The positive sign indicates that higher SAPS1 scores are associated with an increased probability of in-hospital death.
- The model has an AIC of 1534.8, which can be used to compare the relative quality of statistical models for a given dataset.

For the **SOFA model**:
- The coefficient for SOFA is 0.13540 with a p-value < 2e-16, which is also statistically significant. Similar to SAPS1, a higher SOFA score is associated with a higher probability of in-hospital death.
- The AIC for this model is slightly higher at 1555, suggesting that the SAPS1 model might fit the data slightly better when considering only these scores as predictors.


**residual deviance**: The smaller the residual deviance, the better the model fits.
- SAPS1 model has 1530.8 residual deviance on 1963 degrees of freedom
- SOFA model has 1551 residual deviance on 1963 degrees of freedom

**ROC analysis**: The closer the ROC curve is to the top left corner, the higher the overall accuracy of the test. In this case, the SAPS1 model's ROC curve (in red) is closer to the top left corner than the SOFA model's curve (in blue), showing it performs better in your dataset for predicting the outcome.In addition, the SAPS1 model has a higher area under the curve (AUC), confirming its stronger predictive performance compared to the SOFA model in your dataset.
- The SAPS1 model has an AUC of 0.6733918, which suggests it has a fair predictive power. Generally, an AUC close to 0.7 is considered acceptable, but there's room for improvement.
- The SOFA model has an AUC of 0.6392481, which is slightly lower than SAPS1, indicating it is less predictive of in-hospital mortality compared to the SAPS1 model in your dataset.

```{R task1.B_1 test other potential variables could improve the predictive power}

```
# Task 2

### Part A: Exploratory Data Analysis

The goal of this EDA is similar to Task 1 and you may choose to use the same sub-set of predictors if they are relevant and appropriate to the analysis for Task 2. You may also choose to select a different sub-set if you wish. Justify whichever approach you choose.

Present enough information to: (i) explain why you selected these variables, and (ii) Provide an overview of the variables and how they are related to survival. Present your summary using tables and/or plots with supporting commentary where relevant.


### Part B: Explanatory survival model

Your aim is to try to understand and EXPLAIN how survival time varies by `Age`. How does survival change with increasing Age?  Can any age-related differences in survival time be explained by differing clinical presentations of older patients?

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately **explains** the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a univariable model examining the relationship between Age and survival. You should then also fit another one or two multivariable models, to examine the extent that survival is explained by other variables in the dataset and whether age is independently related to survival after controlling for other factors.  Your final model should **not** include all the predictor variables, just a relevant subset of them, which you have selected based on statistical significance and/or background knowledge.  It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at least comment on the possible impact of what your diagnostics show). 

Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.

**Create your response to task 2 here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text. Add code chunks as you see fit and choose whether you wish for the code and or results to be displayed in the final html document.** 

```{r}

```




### Hints

1. Make sure you justify your choice of potential predictors. This could be based on a range of different factors, eg. review of the literature, data quality assessment, strong association with the outcome. 

2. Present the story of your analysis by including explanation and commentary supported by well-presented plots and/or tables. 

3. Make sure all plots and tables are clearly presented with titles and labels as needed. Pay attention to sizing of plots and make sure you check how the rendered result appears. 

4. Clearly define your starting population for the analysis and describe the characteristics of your outcome variable. 

5. Present summaries of appropriate univariate models examining the unadjusted relationship between each predictor and the outcome. 

6. Fit an appropriate series of multivariable regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

7. Present your final model for each task and justify why this model is the most appropriate to answer the analytical question(s). Your final model(s) should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance, background knowledge and relevance to achieving the analytical aim.

8. For your _final model_, present a set of diagnostic statistics and/or charts and comment on them.

9. For each task make sure you write a paragraph or two summarising the most important findings of your analysis. Include reference to the most important results from the statistical output, and a simple clinical interpretation. Make sure your summary of findings addresses the main analytical aim(s) for each task. 




## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works and appears in the right format, and then submit TWO documents via the drop box in OpenLearning (.rmd AND .html).


### Problems?

If you encounter problems with any part of the process described above, please contact the course convenor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assessment is due.


### Additional Information

The instructions are deliberately less prescriptive than the individual assessments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks, you only need to replicate or repeat the steps covered in the course - you do not need to attempt any types of analyses that have not been covered. Refer to the marking rubric for how marks will be awarded.   

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course convenor.   
